---
layout: post
title: "Manually installing CentOS 5.2 on coLinux"
date: 2009-03-16
comments: false
categories:
 - colinux
 - installation
 - centos
---

<div class='post'>
In the <a href="http://blog.gbraad.nl/2009/03/centos-52-image-for-colinux.html">previous post</a> I published a minimal CentOS 5.2 environment for use with coLinux. As I described in the posting, I did a manual installation since I was unable to use Qemu to start the CentOS 5.2 installation process. Although I received a comment that someone else was able to install CentOS, I am still unable to do so... even with the latest build of Qemu (currently 0.9.1) on Windows. Instead of trying to convert a VMware image or using an update process, I wanted to only use coLinux. In this posting I will try to describe what I did.<br /><br /><span style="font-weight:bold;">Requirements</span><br />To ease the installation I have created a base which can assist you with installing. It contains the files you need as images (formatted as Ext3). It is available as centos52-base.rar [<a href="http://dl.getdropbox.com/u/131903/colinux-centos52-base.rar">dropbox</a>] (35kb).<br /><br />This file contains what is needed to install the CentOS 5.2 image for<br />use with coLinux:<br /><ul><br />   <li>system.img  4Gb system image, formatted as Ext3</li><br />   <li>swap512m.img  512Mb swap location</li><br />   <li>Batch and parameters file needed to start coLinux<br/><br />   install.bat, install.txt for the installation process (needed once)<br/><br />   run.bat, run.txt  to start the environment after install</li><br />   <li>instructions.txt file containing the commands to perform</li><br /></ul><br />Extract the base archive and place the CentOS 5.2 (i386) installation media in the same directory. Mirrors are provided on the <a href="http://mirror.centos.org/centos/5/isos/i386">download page</a> of CentOS. If you do not want to download the DVD file, you can also choose to only download CD 1of6. For this you need to change the install.txt parameters file. After the initial install, you can then rely on YUM to install all additional packages.<br /><br />I used a custom init ramdisk to create the images and perform the installation. Since this file is still rough, I suggest you to download this <a href=" http://cdimage.debian.org/debian-cd/5.0.0/i386/iso-cd/">business card iso</a> from debian. The businesscard ISO is about 35Mb.<br /><br />With a tool like winrar (or mount it using a tool like Daemon Tools), you can extract the file /install.386/initrd.gz. If you prefer to only download the <a href="http://dl.getdropbox.com/u/131903/debian-500-i386-initrd.gz">initrd.gz</a>. Save this file as <span style="font-style:italic;">install_initrd.gz</span> in the directory where you extracted this base directory. This ramdisk will be used to start a system to perform commands from which will start the RPM install.<br /><br /><img style="width: 400px; height: 226px;" src="http://lh5.ggpht.com/_ZmgfsgbGDLs/Sb63bmCkY8I/AAAAAAAAEAQ/N30aTNpZEEo/s400/install1.png" border="0" alt="Please choose the language used for the installation process. This language will be the default language for the final system. Choose a language: C - No localization English - English" /><br /><br />After installing coLinux to the standard location you can run the install.bat and start the installation process. It will start the start kernel with the install_initrd.gz as ramdisk. The terminal of choice for this process was a NT terminal, since copy-n-paste was easier to perform. When the installation process interface is shown, you should toggle with ALT+F2 to a console.<br /><br />   Please press Enter to activate this console.<br /><br /><img style="width: 400px; height: 226px;" src="http://lh6.ggpht.com/_ZmgfsgbGDLs/Sb63brlBLtI/AAAAAAAAEAY/chtkT6AMxk4/s400/install2.png" border="0" alt="Please press Enter to activate this console. BusyBox v1.10.2 (Debian 1:1.10.2-2) built-in shell (ash) Enter 'help' for a list of built-in commands." /><br /><br />When you do so, you will see a BusyBox prompt where you can perform the instructions as shown in the instructions.txt.<br /><br /><span style="font-weight:bold;">Instructions</span><br />You will now perform the instructions needed to do the actual install. We will create a basic environment to perform an RPM installation of the base packages. After this you can use YUM to download and/or install additional packages. To create <br />the basic layout:<br /><div style="color:white;background:black"><code><br />mkswap /dev/cobd7<br />swapon /dev/cobd7<br />mkdir /mnt/linux<br />mkdir /mnt/win<br />mkdir /mnt/stage2<br />mount /dev/cobd0 /mnt/linux<br />mkdir -p /mnt/linux/media/cdrom<br />mount -t cofs cofs0 /mnt/win<br />mount /dev/cobd1 /mnt/linux/media/cdrom<br /></code></div><br />This will create some swapspace, a mountpoint <span style="font-style:italic;">/mnt/linux</span> which points to the block device cobd0 (system.img), <span style="font-style:italic;">/mnt/win</span> will be used to point to the coLinux program files folder and <span style="font-style:italic;">/mnt/stage2</span> will later be used to mount the CentOS stage2 image file. Block device cobd1 is used to mount the DVD image to the mountpoint <span style="font-style:italic;">/mnt/linux/media/cdrom</span>. This will later be used to install the base packages from. <br /><br />The stage2 image file uses the squashfs filesystem. CoLinux provides kernel modules to use this filesystem.<br /><div style="color:white;background:black"><code><br />tar xzvf /mnt/win/vmlinux-modules.tar.gz lib/modules/2.6.22.18-co-0.7.3/kernel/fs/squashfs/squashfs.ko<br />insmod /lib/modules/2.6.22.18-co-0.7.3/kernel/fs/squashfs/squashfs.ko<br />mount -t squashfs -o loop /mnt/linux/media/cdrom/images/stage2.img /mnt/stage2<br /></code></div><br />The contents then need to be copied to the <span style="font-style:italic;">/mnt/linux</span> to form the basis of our installation process.<br /><div style="color:white;background:black"><code><br />cp -a /mnt/stage2/ /mnt/linux<br />umount /mnt/stage2<br />mv /mnt/linux/stage2 /mnt/linux/base<br /></code></div><br />This might take some time...<br /><br />The system needs to have some directories which will form the basis. The following command will create this.<br /><div style="color:white;background:black"><code><br />for n in bin dev proc lib usr tmp etc<br />do<br />  mkdir -p /mnt/linux/$n<br />done<br />touch /mnt/linux/etc/fstab /mnt/linux/etc/mtab<br />mkdir -p /mnt/linux/var/lib/rpm<br /></code></div><br />The location <span style="font-style:italic;">/var/lib/rpm</span> is needed to store the RPM database files.<br /><br /><span style="font-weight:bold;">Pre-installation</span><br />RPM will need some libraries to run. These will be copied to the appropriate location using the following commands:<br /><div style="color:white;background:black"><code><br />cd /mnt/linux/lib<br />ln -s ../base/lib/* .<br />rm /mnt/linux/lib/udev<br />rm /mnt/linux/lib/bdevid<br />mkdir /mnt/linux/usr/lib<br />cp -a /mnt/linux/base/usr/lib/librpm-* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/librpmio-* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/librpmdb-* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libpopt.* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libsqlite3.* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libelf* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libbeecrypt.* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libz.* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libbz2.* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/libstdc++.* /mnt/linux/usr/lib/<br />cp -a /mnt/linux/base/usr/lib/rpm /mnt/linux/usr/lib/<br /></code></div><br />All necessary libraries are now available to pivot the root to the <span style="font-style:italic;">/mnt/linux</span> location.<br /><div style="color:white;background:black"><code><br />chroot /mnt/linux /base/usr/bin/sh<br />/base/usr/bin/rpm --initdb<br /></code></div><br />This will create a fresh RPM database which the installation process can use.<br /><br /><span style="font-weight:bold;">Installation</span><br />You are now ready to perform the installation.<br /><div style="color:white;background:black"><code><br />cd /media/cdrom/CentOS<br />/base/usr/bin/rpm -ivh setup-*.rpm<br /></code></div><br />The following packages need to be installed at once. These will form a base installation of CentOS. <br /><div style="color:white;background:black"><code><br />/base/usr/bin/rpm -ivh \<br />audit-libs-[0-9]*.rpm \<br />audit-libs-python-[0-9]*.rpm \<br />authconfig-[0-9]*.rpm \<br />basesystem-[0-9]*.rpm \<br />bash-[0-9]*.rpm \<br />beecrypt-[0-9]*.rpm \<br />bzip2-libs-[0-9]*.rpm \<br />centos-release-[0-9]*.rpm \<br />centos-release-notes-[0-9]*.rpm \<br />checkpolicy-[0-9]*.rpm \<br />chkconfig-[0-9]*.rpm \<br />coreutils-[0-9]*.rpm \<br />cpio-[0-9]*.rpm \<br />cracklib-[0-9]*.rpm \<br />cracklib-dicts-[0-9]*.rpm \<br />cryptsetup-luks-[0-9]*.rpm \<br />cyrus-sasl-lib-[0-9]*.rpm \<br />db4-[0-9]*.rpm \<br />dbus-[0-9]*.rpm \<br />dbus-glib-[0-9]*.rpm \<br />device-mapper-[0-9]*.rpm \<br />device-mapper-event-[0-9]*.rpm \<br />device-mapper-multipath-[0-9]*.rpm \<br />dhclient-[0-9]*.rpm \<br />dhcpv6-client-[0-9]*.rpm \<br />diffutils-[0-9]*.rpm \<br />dmidecode-[0-9]*.rpm \<br />dmraid-[0-9]*.rpm \<br />e2fsprogs-[0-9]*.rpm \<br />e2fsprogs-libs-[0-9]*.rpm \<br />ecryptfs-utils-[0-9]*.rpm \<br />ed-[0-9]*.rpm \<br />elfutils-libelf-[0-9]*.rpm \<br />ethtool-[0-9]*.rpm \<br />expat-[0-9]*.rpm \<br />file-[0-9]*.rpm \<br />filesystem-[0-9]*.rpm \<br />findutils-[0-9]*.rpm \<br />gawk-[0-9]*.rpm \<br />gdbm-[0-9]*.rpm \<br />glib2-[0-9]*.rpm \<br />glibc-[0-9]*.i686.rpm \<br />glibc-common-[0-9]*.rpm \<br />gnu-efi-[0-9]*.rpm \<br />grep-[0-9]*.rpm \<br />grub-[0-9]*.rpm \<br />gzip-[0-9]*.rpm \<br />hal-[0-9]*.rpm \<br />hdparm-[0-9]*.rpm \<br />hwdata-[0-9]*.rpm \<br />info-[0-9]*.rpm \<br />initscripts-[0-9]*.rpm \<br />iproute-[0-9]*.rpm \<br />iptables-[0-9]*.rpm \<br />iptables-ipv6-[0-9]*.rpm \<br />iputils-[0-9]*.rpm \<br />kbd-[0-9]*.rpm \<br />kernel-[0-9]*.rpm \<br />keyutils-libs-[0-9]*.rpm \<br />kpartx-[0-9]*.rpm \<br />krb5-libs-[0-9]*.rpm \<br />kudzu-[0-9]*.rpm \<br />less-[0-9]*.rpm \<br />libacl-[0-9]*.rpm \<br />libattr-[0-9]*.rpm \<br />libcap-[0-9]*.rpm \<br />libgcc-[0-9]*.rpm \<br />libgcrypt-[0-9]*.rpm \<br />libgpg-error-[0-9]*.rpm \<br />libhugetlbfs-[0-9]*.rpm \<br />libselinux-[0-9]*.rpm \<br />libselinux-python-[0-9]*.rpm \<br />libsemanage-[0-9]*.rpm \<br />libsepol-[0-9]*.rpm \<br />libstdc++-[0-9]*.rpm \<br />libsysfs-[0-9]*.rpm \<br />libtermcap-[0-9]*.rpm \<br />libusb-[0-9]*.rpm \<br />libuser-[0-9]*.rpm \<br />libvolume_id-[0-9]*.rpm \<br />libxml2-[0-9]*.rpm \<br />libxml2-python-[0-9]*.rpm \<br />lvm2-[0-9]*.rpm \<br />m2crypto-[0-9]*.rpm \<br />MAKEDEV-[0-9]*.rpm \<br />mcstrans-[0-9]*.rpm \<br />mingetty-[0-9]*.rpm \<br />mkinitrd-[0-9]*.rpm \<br />mktemp-[0-9]*.rpm \<br />module-init-tools-[0-9]*.rpm \<br />nash-[0-9]*.rpm \<br />ncurses-[0-9]*.rpm \<br />net-tools-[0-9]*.rpm \<br />newt-[0-9]*.rpm \<br />nspr-[0-9]*.rpm \<br />nss-[0-9]*.rpm \<br />openldap-[0-9]*.rpm \<br />openssh-[0-9]*.rpm \<br />openssh-clients-[0-9]*.rpm \<br />openssh-server-[0-9]*.rpm \<br />openssl-[0-9]*.i686.rpm \<br />pam-[0-9]*.rpm \<br />passwd-[0-9]*.rpm \<br />pciutils-[0-9]*.rpm \<br />pcre-[0-9]*.rpm \<br />pm-utils-[0-9]*.rpm \<br />policycoreutils-[0-9]*.rpm \<br />popt-[0-9]*.rpm \<br />prelink-[0-9]*.rpm \<br />procps-[0-9]*.rpm \<br />psmisc-[0-9]*.rpm \<br />python-[0-9]*.rpm \<br />python-elementtree-[0-9]*.rpm \<br />python-iniparse-[0-9]*.rpm \<br />python-sqlite-[0-9]*.rpm \<br />python-urlgrabber-[0-9]*.rpm \<br />readline-[0-9]*.rpm \<br />redhat-logos-[0-9]*.rpm \<br />rhpl-[0-9]*.rpm \<br />rootfiles-[0-9]*.rpm \<br />rpm-[0-9]*.rpm \<br />rpm-libs-[0-9]*.rpm \<br />rpm-python-[0-9]*.rpm \<br />sed-[0-9]*.rpm \<br />selinux-policy-[0-9]*.rpm \<br />selinux-policy-targeted-[0-9]*.rpm \<br />setools-[0-9]*.rpm \<br />setserial-[0-9]*.rpm \<br />shadow-utils-[0-9]*.rpm \<br />slang-[0-9]*.rpm \<br />sqlite-[0-9]*.rpm \<br />sysfsutils-[0-9]*.rpm \<br />sysklogd-[0-9]*.rpm \<br />system-config-securitylevel-tui-[0-9]*.rpm \<br />SysVinit-[0-9]*.rpm \<br />tar-[0-9]*.rpm \<br />tcl-[0-9]*.rpm \<br />tcp_wrappers-[0-9]*.rpm \<br />termcap-[0-9]*.rpm \<br />tzdata-[0-9]*.rpm \<br />udev-[0-9]*.rpm \<br />udftools-[0-9]*.rpm \<br />usermode-[0-9]*.rpm \<br />util-linux-[0-9]*.rpm \<br />vim-minimal-[0-9]*.rpm \<br />wireless-tools-[0-9]*.rpm \<br />yum-[0-9]*.rpm \<br />yum-metadata-parser-[0-9]*.rpm \<br />zlib-[0-9]*.rpm<br /></code></div><br />If you perform the command, the following will show indicating that the installation process started.<br /><img style="width: 400px; height: 226px;" src="http://lh6.ggpht.com/_ZmgfsgbGDLs/Sb7CBbq-d_I/AAAAAAAAEAo/wmQeB7eTx0k/s400/install4.png" alt="RPM installation process" /><br />This will again take some time... and will eventually result in the following.<br /><img style="width: 400px; height: 226px;" src="http://lh6.ggpht.com/_ZmgfsgbGDLs/Sb7Cu1wUJRI/AAAAAAAAEAw/tTKTKyDtVTM/s400/install5.png" /><br />If no error occurred you can start with the post-installation to make the system usable from coLinux.<br /><br /><span style="font-weight:bold;">Post-installation</span><br />We will now perform some post-installation commands to finish the installation. Create the device nodes in the device directory. These will be used by the filesystem table to mount the filesystem. Do not forget to first exit out of the chroot environment.<br /><div style="color:white;background:black"><code><br />exit<br />mknod -m 666 /mnt/linux/dev/null c 1 3<br />for i in 0 1 2 3 4 5 6 7 8 9 10<br />do<br />  mknod -m 660 /mnt/linux/dev/cobd${i} b 117 ${i}<br />done<br />chown 0:6 /mnt/linux/dev/cobd*<br /></code></div><br />To have the filesystems mounted on startup you need to have the fstab file being created. Just overwrite the current file:<br /><div style="color:white;background:black"><code><br />cat > /mnt/linux/etc/fstab << END<br />/dev/cobd0   /          ext3     defaults        1 1<br />/dev/cobd7   swap       swap     defaults        0 0<br />none         /proc      proc     defaults        0 0<br />none         /dev/shm   tmpfs    defaults        0 0<br />none         /dev/pts   devpts   gid=5,mode=620  0 0<br />none         /sys       sysfs    defaults        0 0<br />END<br /></code></div><br />Write some basic information to the hosts file.<br /><div style="color:white;background:black"><code><br />cat > /mnt/linux/etc/hosts << END<br />127.0.0.1 localhost localhost.localdomain<br />END<br /></code></div><br />The following will create the shared memory and the pseudo terminal devices, turns off the hardware daemon and allows you to give an initial password for the root user.<br /><div style="color:white;background:black"><code><br />chroot /mnt/linux /sbin/MAKEDEV con<br />chroot /mnt/linux /bin/bash -c "/bin/mkdir /dev/{shm,pts}"<br />chroot /mnt/linux /bin/bash -c "/bin/chmod a+rwxt /dev/shm"<br />chroot /mnt/linux /sbin/MAKEDEV generic<br />chroot /mnt/linux /sbin/chkconfig haldaemon off<br />chroot /mnt/linux /usr/sbin/authconfig --enableshadow --update<br />chroot /mnt/linux /usr/bin/passwd root<br /></code></div><br />To have the network start, you need to create the following files. This way your system will be configured with a basic hostname and two network devices using DHCP.<br /><div style="color:white;background:black"><code><br />cat > /mnt/linux/etc/sysconfig/network << END<br />NETWORKING=yes<br />HOSTNAME=localhost.localdomain<br />END<br /></code></div><br /><div style="color:white;background:black"><code><br />cat > /mnt/linux/etc/sysconfig/network-scripts/ifcfg-eth0 << END<br />DEVICE=eth0<br />BOOTPROTO=dhcp<br />ONBOOT=yes<br />TYPE=Ethernet<br />END<br /></code></div><br /><div style="color:white;background:black"><code><br />cat > /mnt/linux/etc/sysconfig/network-scripts/ifcfg-eth0 << END<br />DEVICE=eth1<br />BOOTPROTO=dhcp<br />ONBOOT=yes<br />TYPE=Ethernet<br />END<br /></code></div><br /><span style="font-weight:bold;">Cleanup</span><br />You can now remove the base directory we had copied from the stage2 image.<br /><div style="color:white;background:black"><code><br />rm -rf /mnt/linux/base<br />halt<br /></code></div><br />After this you can halt the system and start the environment using the <span style="font-style:italic;">run.bat</span> file. If everything went well your system would look like this!<br /><img style="width: 400px; height: 226px;" src="http://lh4.ggpht.com/_ZmgfsgbGDLs/Sb7GZ6einxI/AAAAAAAAEA4/8WWXLCyp1eQ/s400/install6.png" /><br />During startup you will notice some minor error which are related to the kernel dependencies file being missing. To solve this, you can extract the kernel modules using the <span style="font-style:italic;">/dev/cofs0</span> mapping. Although I prefer to use RPMs, since they are easier to cleanup and upgrade when needed.<br /><div style="color:white;background:black"><code><br />yum install wget<br />wget http://gbraad.fedorapeople.org/files/kernel-modules-2.6-co0.7.3.i386.rpm<br />rpm -ivh kernel-modules-2.6-co0.7.3.i386.rpm<br /></code></div><br />Enjoy using it... If you have suggestions or stories about your use, leave a comment or send me an email.</div>
