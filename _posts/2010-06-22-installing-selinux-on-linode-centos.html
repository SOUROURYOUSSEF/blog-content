---
layout: post
title: "Installing SELinux on Linode (CentOS profile)"
date: 2010-06-22
comments: false
categories:
 - selinux
 - installation
 - howto
 - centos
 - virtualization
 - xen
 - linode
 - yum
 - vps
 - x86_64
---

<div class='post'>
Recently I signed up for a different VPS hosting partner as the one I was using had a dreadful latency when dealing with international connections. The new VPS at <a href="http://bit.ly/LinodeSignup">Linode</a> I am using has good ping times, the control panel often does correctly what it should do, but the out-of-the-box CentOS profile was in my opinion not what I am used to.<br /><br />RHEL and Fedora sys-admins know about <a href="http://fedoraproject.org/wiki/SELinux">SELinux</a> and the pains and pleasures it can induce. If you are new to SELinux, be sure to read a little bit of background: <a href="http://fedoraproject.org/wiki/SELinux/Understanding">SELinux for dummies</a> and <a href="http://danwalsh.livejournal.com/">Dan Walsh's Blog</a>. Or watch these videos recorded by Scott Dowdle: "<a href="http://www.montanalinux.org/screencast-selinux-demystified-bozemanlug2010.html">SELinux demystified</a>", "Intro to SELinux" <a href="http://www.montanalinux.org/lfnw2010-selinux-pt1.html">Part 1</a>, <a href="http://www.montanalinux.org/lfnw2010-selinux-pt2.html">Part 2</a>.<br /><br />It seems Linode does not provide SELinux support with their provided kernel. I do not know what their motivation is. Maybe they want to relieve their support of troubling questions (to which I would say: permissive or enforcing=0) or maybe they just don't see the need. However after reading several reports on the web I am sure people want this functionality, but have been troubled by out-of-date resources about recompilation of the kernel to get the needed SELinux support and paravirtualization operations (pv_ops), setting up pv-grub, etc.<br /><br />Well, things are now much simpler as RHEL/CentOS provides the needed pv_ops kernels. The only missing part is to setup grub and get SELinux going. In several steps I will explain what needs to be done.<br /><br /><b>Instructions</b><br />For these instructions I created a standard CentOS 5.5 (64bit) profile VPS using Linode's <a href="https://www.linode.com/members/linode/dashboard.cfm">Dashboard</a> option 'Deploy a distribution'. Start the node and from the <a href="https://www.linode.com/members/linode/console.cfm">console</a> or <i>ssh</i> perform these steps.<br /><br /><b>1. Install grub</b><br />Grub is not installed on the base system. You will need to install the package, create some symlinks and an empty configuration file which you will need later.<br /><br /><div style="background-color: black; color: white;"><code># yum install grub<br /># mkdir /boot/grub<br /># cd /boot/grub/<br /># touch grub.conf<br /># ln -s ../boot/grub/grub.conf /etc/grub.conf<br /># ln -s ./grub.conf menu.lst</code></div><br /><b>2. Install kernel with pv_ops </b><br />You will need to install a Xen enabled kernel which are provided by CentOS. But for some reason the <i>xennet</i> and <i>xenblk</i> are provided as modules and fail during startup. To solve this issue we create a new <i>initrd</i> which can load these. Be sure to specify your kernel version correctly. You will also need this later for Grub.<br /><br /><div style="background-color: black; color: white;"><code># yum install kernel-xen<br /># mkinitrd -v -f --with=ext3 --with=xennet --with=xenblk /boot/initrd-2.6.18-194.3.1.el5xen-custom.img 2.6.18-194.3.1.el5xen<br /># echo "devpts    /dev/pts    devpts    defaults  0 0" &gt; /etc/fstab</code></div><br /><b>3. Edit grub.conf</b><br />To enable the new kernel, you need to add this to our empty grub.conf. Be sure to verify your version.<br /><br /><div style="background-color: black; color: white;"><code># vi /etc/grub.conf</code></div><br />The contents of the grub.conf are:<br /><br /><div style="background-color: black; color: white;"><code>#boot=/dev/vxda<br />default=0<br />timeout=1<br />hiddenmenu<br />title CentOS<br />root (hd0)<br />kernel /boot/vmlinuz-2.6.18-194.3.1.el5xen ro root=/dev/xvda<br />initrd /boot/initrd-2.6.18-194.3.1.el5xen-custom.img<br />title CentOS (enforcing=0)<br />root (hd0)<br />kernel /boot/vmlinuz-2.6.18-194.3.1.el5xen ro root=/dev/xvda enforcing=0<br />initrd /boot/initrd-2.6.18-194.3.1.el5xen-custom.img</code></div><br />The above configuration will automatically boot to the default option which is a pv_ops kernel which has SELinux enabled. The second boot option is handy of you encounter some issues during the next step. If you are uncertain, you can uncomment the following lines, but this means the boot will be interrupted by grub and needs you to select the boot option from the lish console.<br /><br /><div style="background-color: black; color: white;"><code>#default=0<br />#timeout=1</code></div><br /><b>4. Install SELinux</b><br />Installing SELinux now is a breeze.<br /><br /><div style="background-color: black; color: white;"><code># yum install libselinux selinux-policy selinux-policy-targeted<br /># genhomedircon<br /># touch /.autorelabel<br /># shutdown -h now</code></div><br />Now you only need to set your node to use pv-grub to boot from the configuration profile. This is briefly explained in <a href="http://library.linode.com/Fzatyb">this article</a> on the Linode Library. Boot up your node and allow some time for the relabeling. It might be wise to verify the progress from the lish console. If everything went well, the filesystem should have been been relabeled after a while and the system should operate 'as normal' ;-). You can verify the state of SELinux from <i>ssh</i> using the command <i>sestatus</i>.<br /><br />There is however still one issue I have not resolved, as soon as the console is handled by <i>mingetty</i>, it seems the lish console does not properly handle this. It might be an issue to use xvc0 instead, but I see this as a minor problem and rather have SELinux enabled.If you have a fix, please let me know so I can improve these instructions.</div>
