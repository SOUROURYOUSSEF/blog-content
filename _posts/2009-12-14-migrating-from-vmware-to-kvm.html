---
layout: post
title: "Migrating from VMware to KVM"
date: 2009-12-14
comments: false
categories:
 - redhat
 - qemu
 - installation
 - howto
 - centos
 - fedora
 - rhel
 - vmware
 - kvm
---

<div class='post'>
A lot of reports on the internet talk about the reduction of costs when you invest in virtualization. This is something I will certainly not deny after many years of experience with VMware Workstation, VMware Fusion, VMware GSX (now VMware Server) and VMware ESX and having implemented several high-availability setups using ESX. Even at home I had several whitebox servers with <a href="http://picasaweb.google.com/lh/photo/9ftwxi4UAsNwhjDJK1bIFQ">Virtual Center</a>... until I migrated away to KVM. In this article I will explain the reason of the migration and how to perform it with an example.&nbsp;It is written towards people who currently run VMware GSX or VMware Server on Linux.<br /><br /><b>Motivation</b><br />It is undeniable that virtualization provide you with a lot of benefits; consolidation of servers will save you money. Maintaining your virtualized servers becomes a breeze, since they are all accessible from a single front-end. But implementing your environment on VMware comes at a price... even for the free version VMware Server; maintenance.&nbsp;You will still need to monitor your virtualization servers for performance and distribute your virtual machines among your servers or resource pools according to load. Although there are tools available to assist you, it is not the biggest issue.<br /><br />VMware Server requires an additional operating system like Linux (or Windows). This introduces an added maintenance dependency; kernel modules which VMware uses need to be recompiled when the kernel gets updated. If a security exploit is found in the kernel, the virtualization host can be compromised and therefore jeopardize the continuity of your business. To prevent this, you update the kernel, but on reboot you notice that VMware does not start properly. On the command line you will need to perform a <i>vmware-config.pl</i> which build the modules. Unfortunately, your kernel headers are newer and either<i> vmmon</i> (virtual machine monitor) or <i>vmnet</i> (network component) does not build properly. Because of this, your whole infrastructure is offline until VMware provides new components or the release of the community patch package '<a href="http://communities.vmware.com/message/76957">vmware-any-any</a>'.<br /><br />Users of VMware ESX will not have this issue, since the operating system and modules are provided in the form of the VMware's <i>vmkernel</i>. If a security update is needed, you only need to install an update. The previously mentioned&nbsp;issue &nbsp;has happened to me often enough and I&nbsp;I wanted to have the same solution as ESX, but with the convenience of using Un*x/Linux experience for maintenance without the dependency of a&nbsp;third-party&nbsp;product. Since RHEL 5.4 this is provided as an enterprise supported solution;&nbsp;KVM, the&nbsp;<a href="http://www.linux-kvm.com/">Kernel-based Virtual Machine</a>, once developed by Qumranet and now owned by RedHat. And by using <a href="http://www.centos.org/">CentOS</a> this is available to everyone without too much trouble.<br /><br />There are some differences between VMware and KVM. KVM is provided as part of the kernel, so any Linux distribution can provide it as part of their offering. KVM supports different formats for a virtual&nbsp;hard disk, while VMware only uses their own VMDK format. VMware can run in a full virtualized mode and is therefore suitable for older hardware. KVM needs a processor that provides <a href="http://en.wikipedia.org/wiki/X86_virtualization#Hardware_support">VT-x (Intel) or AMD-V (AMD)</a> to operate. VMware can run x86_64 guests on a i686 host, while KVM can not.<br /><br />Because of this last reason, I had to reinstall CentOS on one of my systems, since it still ran an i686 version of CentOS 5.4 (on a Core2Duo E6600). This provides a good overview of what needs to be done to run KVM on CentOS.<br /><br />Note: since KVM uses <i>qemu</i> to emulate any hardware you can also choose to use qemu without KVM as the hypervisor, but instead use the kqemu kernel module.<br /><br /><b>Installation</b><br /><a href="http://picasaweb.google.com/lh/photo/ncEH8sxHtZESZKToIMuTBQ?feat=embedwebsite" style="float: right;"><img src="http://lh4.ggpht.com/_ZmgfsgbGDLs/SyVEVDP6AyI/AAAAAAAAHwE/INGRcuIqpW0/s288/host-install.png" /></a><br />You will need to <a href="http://mirror.centos.org/centos/5/isos/">download</a> an installation disc of CentOS 5.4. Prefer to use the x86_64 version;&nbsp;<i>CentOS-5.4-x86_64-bin-DVD.iso</i>. During the installation you can keep the default settings and when asked for the 'additional tasks' you will perform, do not select the 'Virtualization' option. After the installation finished, you will need to update the system to the latest updates.<br /><br />From the reinstall I noticed a minor error in the CentOS 5.4 x86_64 installation. Due to installing openssl.i686 it also installed a lot of other standard i386-arch libraries. You can find out if you also have those packages installed as described in a <a href="http://blog.gbraad.nl/2009/08/accidently-installed-i386-packages-on.html">earlier post</a>. If you also want to remove those packages, perform the following command line option before continuing.<br /><br /><div style="background-color: black; color: white;"><code>$ rpm -e `rpm -qa --qf '%{name}.%{ARCH}\n' |grep i386` openssl.i686</code><br /></div><br />To update your system:<br /><br /><div style="background-color: black; color: white;"><code>$ yum update</code><br /></div><br />If your system is up-to-date, continue to install the needed packages for KVM and <a href="http://virt-manager.et.redhat.com/">Virt-Manager</a>.<br /><br /><div style="background-color: black; color: white;"><code>$ yum install bridge-utils kvm kvm-qemu virt-manager virt-viewer python-virtinst</code><br /></div><br />In later versions of CentOS it might suffice to issue the command "<i>yum groupinstall 'Virtualization'</i>", but currently this installs a Xen enabled kernel. According to the used processor, you can test to load the needed kernel module and start the <i>libvirt</i> daemon.<br /><br /><div style="background-color: black; color: white;"><code>$ modprobe kvm<br />$ modprobe kvm-intel <i>(or kvm-amd)</i><br />$ service libvirtd start</code></div><br />I normally use a different management workstation. And as an example I use a Fedora 12 installation to connect to the virtualization host (beibei). First from a tunneled connection to the host (with X11 forwarding).<br /><br /><div style="background-color: black; color: white;"><code>$ ssh -X root@beibei<br />root@beibei's password: **************<br /># virt-manager</code><br /></div><br />This will start the Virtual Machine Manager from which you can create new instances.&nbsp;You can of course use a Gnome desktop from the CentOS system to manage your virtual machines, but it pays off to try a seperate management workstation. This will allow you to try additional features, like live migrations between KVM virtualization servers.<br /><br />This is all it needs to install KVM on a CentOS 5.4 installation. For an earlier version of CentOS, it is best to consult the <a href="http://wiki.centos.org/HowTos/KVM">wiki article about KVM</a>.<br /><br /><b>Network settings</b><br />A default VMware Server installation will bridge the network card you have. You will probably want to have the same configuration for your KVM environment. For this you need standard Linux bridging utilities.<br /><br /><div style="background-color: black; color: white;"><code>$ yum install bridge-utils</code><br /></div><br />You only need to edit (or create) some network-scripts to make a bridge work.<br /><br /><div style="background-color: black; color: white;"><code>$ vi /etc/sysconfig/network-scripts/ifcfg-eth0<br />DEVICE=eth0<br /><s> HWADDR=00:1a:2b:3c:4d:5e</s><br />ONBOOT=yes<br />BRIDGE=br0</code><br /></div><br />And create the bridge<br /><br /><div style="background-color: black; color: white;"><code>$ vi /etc/sysconfig/network-scripts/ifcfg-br0<br />DEVICE=br0<br /><s> BOOTPROTO=dhcp</s><br />ONBOOT=yes<br />TYPE=Bridge</code><br /></div><br />When you start the network again, you will have a <i>br0</i> and <i>eth0</i> device.<br /><br /><div style="background-color: black; color: white;"><code>$ service network restart</code><br /></div><br />You will now be able to select a bridged network card inside the KVM virtual machine configuration. If you have more network card, create a bridge per network card.<br /><br /><b>Converting the virtual disk files</b><br />For the migration part I choose a virtual machine who once began it's life as a <a href="http://picasaweb.google.com/lh/photo/D73i0Oqxov1U7lrY9e4s8A">physical machine</a>; forum.survion.net. It is a Linux installation once based on FC3, <a href="http://blog.gbraad.nl/2009/01/wizard-of-yum-upgrade-from-fc3-to.html">got migrated to CentOS</a>... and then&nbsp;<a href="http://picasaweb.google.com/lh/photo/qH4c-INqH_WZ-QaP3Qlvvw">ran as a VMware virtual machine</a>.<br /><br />The VMware virtual machine consists of one or more hard disk files, with the extension <i>.vmdk</i> and a description file, with the extension <i>.vmx</i>. A listing of <i>server-forum.vmwarevm</i> looks like:<br /><br /><div style="background-color: black; color: white;"><pre>[root@beibei server-forum.vmwarevm]# ls -al<br />total 29405144<br />drwxr-xr-x  2 root users        4096 Dec 12 20:53 .<br />drwxr-xr-x 21 root root         4096 Dec  9 17:32 ..<br />-rwxr-xr-x  1 root vmware       8684 Dec  7 21:09 nvram<br />-rw-------  1 root vmware          0 Jan  3  2009 Red Hat Linux.vmsd<br />-rwxr-xr-x  1 root vmware       2369 Dec  7 21:09 Red Hat Linux.vmx<br />-rw-r--r--  1 root vmware        268 Jan  3  2009 Red Hat Linux.vmxf<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 storage-f001.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:20 storage-f002.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:21 storage-f003.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:20 storage-f004.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 storage-f005.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Aug 30 14:45 storage-f006.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 storage-f007.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Oct 25 19:18 storage-f008.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Nov 30 04:05 storage-f009.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Nov 30 04:04 storage-f010.vmdk<br />-rw-r--r--  1 root vmware    2621440 Jul 23  2008 storage-f011.vmdk<br />-rw-r--r--  1 root vmware        749 Dec  7 21:11 storage.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 system-f001.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 system-f002.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 system-f003.vmdk<br />-rw-r--r--  1 root vmware 2147221504 Dec  7 22:22 system-f004.vmdk<br />-rw-r--r--  1 root vmware   17659904 Jul 23  2008 system-f005.vmdk<br />-rw-r--r--  1 root vmware        616 Dec  7 21:11 system.vmdk</pre></div><br />As you can see, there are two hard disks (system and storage) and several other files. The hard disk as shown here is a fully allocated file which is divided up in seperate 2Gb files (handy for use on a FAT32 filesystem for portability). We have to convert it back into a monolithic file for use on KVM. Luckily KVM understands the monolithic VMDK file format, so we will choose this for interoperability. To convert the file you can use a VMware provided tool called <i>vmware-vdiskmanager</i> (includes with VMware products).<br /><br /><div style="background-color: black; color: white;"><code>$ vmware-vdiskmanager -r system.vmdk -t 0 forum-system.img<br />$ vmware-vdiskmanager -r storage.vmdk -t 0 forum-storage.img</code><br /></div><br />After this you will have two files that need to be copied to the in the images folder of libvirt on the virtualization host (<i>/var/lib/libvirt/images/</i>). You can do this using <i>scp</i>, <u><i>ftp</i></u> or mount an <i>NFS</i> export. From here we can create a virtual machine to connect these disk files to. Connect to the virtualization host and start the Virtual Machine Manager.<br /><br /><b>Create the Virtual Machine</b><br />Select localhost and create a new virtual machine using the context menu. Give it a unique name that identifies it easily for you, as I did: server-forum. If KVM is installed properly, you can only select "Full virtualized' from the Virtualization Method. Select the CPU architecture that fits your former VMware virtual machine and as the hypervisor: kvm.<br /><br /><a href="http://picasaweb.google.com/lh/photo/KHj7sXmPXBCtbNqb44TUcw"><img src="http://lh4.ggpht.com/_ZmgfsgbGDLs/SyVfP8LLpZI/AAAAAAAAHwk/Cp5_7_6JdWA/s400/virtual-method-window.png" /></a><br /><br />On the 'Installation Method' page choose 'Network boot (PXE)' so you don't have to select a installation disk image.<br /><br /><a href="http://picasaweb.google.com/lh/photo/j2ubjLoplt0E0ojFQxVYdg"><img src="http://lh6.ggpht.com/_ZmgfsgbGDLs/SyVfP9IBPBI/AAAAAAAAHwo/N6rGaYgPRco/s400/install-method-window.png" /></a><br /><br />On the 'Storage' page you deselect the 'Allocate entire virtual disk now' since we will not use the create virtual hard disk image. Beware; don't let the size become 0, since this way libvirt will not create the disk file and will fail to create the virtual machine.<br /><br /><a href="http://picasaweb.google.com/lh/photo/pRN911zC7BJlLixK2-Vsgg"><img src="http://lh4.ggpht.com/_ZmgfsgbGDLs/SyVgtQHV2lI/AAAAAAAAHww/wu8OISZLUss/s400/network-window.png" /></a><br /><br />On the 'Network' page you will probably want to select the bridged network card. This gives you the same functionality as VMware did as default option. On the 'Memory and CPU Allocation page' you can adjust the settings which are most close to your former virtual machine. After the summary the virtual machine will start automatically. Immediately issue a 'Force Off' as Shut down option. Now select the 'Hardware' tab.<br /><br /><a href="http://picasaweb.google.com/lh/photo/87LIAgWBnsI-vJ8phrArVA"><img src="http://lh6.ggpht.com/_ZmgfsgbGDLs/SyVkYSgnagI/AAAAAAAAHw0/CYdB_F9Sf2c/s400/vm-hardware-window.png" /></a><br /><br />Remove the 'Disk hda' and add new hardware of the type 'Storage' and select the system file from the storage location. If you have selected the file, you will see the correct size. Do the same of the other disks you have.<br /><br /><a href="http://picasaweb.google.com/lh/photo/a36wVcZNSQVPekYw6xTaDw?feat=embedwebsite"><img src="http://lh5.ggpht.com/_ZmgfsgbGDLs/SyVl01FEfGI/AAAAAAAAHw4/kGS1x0BM_6Y/s400/vm-boot-window.png" /></a><br /><br />Be sure to change the boot device in the Boot options of this VM. Else it will try to start using Network (PXE) instead of the virtual hard disk.<br /><br />Now everything should be ok to start the virtual machine.<br /><br /><b>Issues you might encounter</b><br />The conversion will probably not be without problems. For instance, I had a <a href="http://bugs.centos.org/view.php?id=2912">common issue with the kernel</a> of the virtual machine. Due to a kernel panic it did not start properly. Fortunately tools are available to perform actions of the virtual hard disk files. One of those tools is <a href="http://libguestfs.org/">guestfish</a>. On CentOS and Fedora you can install this tool using:<br /><br /><div style="background-color: black; color: white;"><code>$ yum install guestfish</code><br /></div><br />For instance, I had to download a newer kernel and try to install this inside the virtual machine. The following commands show what I did:<br /><br /><div style="background-color: black; color: white;"><code>$ guestfish<br />fs# add /var/lib/libvirt/images/forum-system.img<br />fs# run<br />Could not open '/dev/kqemu' - QEMU acceleration layer not activated: No such file or directory<br />fs# mount /dev/sda2 /<br />fs# mount /dev/sda1 /boot<br />fs# upload /tmp/downloaded.rpm /tmp/kernel.rpm<br />fs# command "rpm -ivh /tmp/kernel.rpm"<br />fs# vi /boot/grub/grub.conf</code><br /></div><br />These commands will add the <i>forum-system.img</i> to a qemu instance. Inside the qemu instance you will then mount the mountpoints, upload the kernel RPM from the local path to the tmp inside the filesystem. From here nothing special... and then it will issue a command inside qemu to install the kernel package. This command will run inside the filesystem as if it performed the command from the commandline. Finally I verify the grub configuration and change it if necessary.&nbsp;From here I was able to start the virtual machine without any errors.<br /><br />Note: If you convert Windows virtual machines you might encounter more issues. Those conversion steps are outside the scope of this document, but are not impossible to perform.<br /><br /><b>Fedora 12</b><br />The latest release of Fedora includes <a href="http://fedoraproject.org/wiki/Virtualization_improvements_in_Fedora_12">many improvements</a> which are virtualization related. If you want to try KVM on a workstation, you should definitely try Fedora 12.<br /><br />Below here you can see virt-manager. The interface has changed a little. As you can see from the screenshot, it is connected to the local machine and two remote hosts. The console is shown from the remote host (using <i>ssh</i> and <i>vnc</i>). For this no additional configuration was needed.<br /><br /><a href="http://picasaweb.google.com/lh/photo/bM8ahy6bt-WhBQbJhEZEBg"><img src="http://lh3.ggpht.com/_ZmgfsgbGDLs/SyQVBLMeLhI/AAAAAAAAHu8/xJzllFxeT6A/s400/vm-running.png" /></a><br /><br />It is easy to monitor the performance of a virtual machine using the Virtual Machine Manager. Here you can see the server-forum instance with an overview of CPU/Memory usage and Disk/Network activity.<br /><br /><a href="http://picasaweb.google.com/lh/photo/CRkLwK-4T5knIMJiiH7LfA"><img src="http://lh5.ggpht.com/_ZmgfsgbGDLs/SyQVBfmXuPI/AAAAAAAAHvA/E0RkzpQ_DO4/s400/vm-performance.png" /></a><br /><br />Just a few days ago SPICE was released. This is an alternative to <i>vnc</i> to view the console of a virtual machine. It is target towards the use of a Virtual Desktop. More information about this can be found on the <a href="http://www.spice-space.org/">SPICE website</a>. A <a href="http://www.linux-kvm.com/content/getting-started-spice-fedora-12">how-to for Fedora 12</a> is available.</div>
