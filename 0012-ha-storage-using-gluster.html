
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Highly Available storage using GlusterFS Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="0013-document-generation.html" />
    
    
    <link rel="prev" href="0008-multitier-setup-openstack.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">2014</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="0001-javascript-loaders.html">
            
                <a href="0001-javascript-loaders.html">
            
                    
                    JavaScript Loaders
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="0002-trigger-phonegap-build-from-github.html">
            
                <a href="0002-trigger-phonegap-build-from-github.html">
            
                    
                    Trigger PhoneGap builds from GitHub
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">2016</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="0003-hello-internet.html">
            
                <a href="0003-hello-internet.html">
            
                    
                    Hello, Internet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="0004-setup-self-hosted-cloud9.html">
            
                <a href="0004-setup-self-hosted-cloud9.html">
            
                    
                    Setting up a powerful self-hosted IDE in the cloud
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="0005-custom-ceph-atomic-deployment.html">
            
                <a href="0005-custom-ceph-atomic-deployment.html">
            
                    
                    Deployment of Ceph using custom Atomic images
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="0006-nonroot-container.html">
            
                <a href="0006-nonroot-container.html">
            
                    
                    non-root user inside a Docker container
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="0007-highlighting-code-text.html">
            
                <a href="0007-highlighting-code-text.html">
            
                    
                    Highlighting of Code and Text
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="0008-multitier-setup-openstack.html">
            
                <a href="0008-multitier-setup-openstack.html">
            
                    
                    Building a multi-tier application using OpenStack (PackStack)
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.7" data-path="0012-ha-storage-using-gluster.html">
            
                <a href="0012-ha-storage-using-gluster.html">
            
                    
                    Highly Available storage using GlusterFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="0013-document-generation.html">
            
                <a href="0013-document-generation.html">
            
                    
                    Document generation using Markdown and Pandoc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="0015-mentor-recommended-books.html">
            
                <a href="0015-mentor-recommended-books.html">
            
                    
                    Mentors and recommended books
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="0016-object-design.html">
            
                <a href="0016-object-design.html">
            
                    
                    Object Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="0017-kubernetes-ansible.html">
            
                <a href="0017-kubernetes-ansible.html">
            
                    
                    Deploying Kubernetes using Ansible
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.12" data-path="0018-openshift-cluster-up.html">
            
                <a href="0018-openshift-cluster-up.html">
            
                    
                    Deploying OpenShift
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.13" data-path="0019-setup-docker-storage.html">
            
                <a href="0019-setup-docker-storage.html">
            
                    
                    Setup Docker storage to use LVM thin pool
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.14" data-path="0020-openshift-example.html">
            
                <a href="0020-openshift-example.html">
            
                    
                    Run an example application on OpenShift
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.15" data-path="0021-give-to-content-creators.html">
            
                <a href="0021-give-to-content-creators.html">
            
                    
                    Giving to your favourite content creators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.16" data-path="0022-dear-recruiter.html">
            
                <a href="0022-dear-recruiter.html">
            
                    
                    Dear recruiter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.17" data-path="0023-ansible-to-replace-scripts-packages.md">
            
                <span>
            
                    
                    Replace scripts with Ansible: package installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.18" data-path="0024-personal-kanban-using-gitlab.md">
            
                <span>
            
                    
                    Task management and Personal Kanban: how I use GitLab Issues
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Highly Available storage using GlusterFS</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p>In this article I will describe how you can setup a webserver environment with
Highly Available (HA) storage, provided by GlusterFS. We will be setting up a
simple environment in which storage between two webservers needs to be replicated.</p><p>GlusterFS is a scalable network filesystem suitable for data-intensive tasks. It
is free and open source software and can utilize common off-the-shelf hardware.
To learn more, please see the Gluster project <a href="http://www.gluster.org/" target="_blank">home page</a>.</p><h2 id="prerequisites">Prerequisites</h2><p>You will need two servers available, each with a dedicated disk for storage,
such as <code>/dev/vdb</code> or <code>/dev/sdb</code>. I will be using Fedora 24, which of writing
is the latest version.</p><p>The following needs to be installed on both servers:</p><pre><code>$ dnf install -y glusterfs-server xfsprogs</code></pre>
<p>This includes the server component for the distributed filesystem, and the tools
needed to format the disk we will use to store the files. Gluster recommends to
use XFS as the filesystem.</p><p>We will assume for this article, that the machines will be running Apache. If
this is not installed already, you can do the following:</p><pre><code>$ dnf install -y httpd</code></pre>
<h2 id="hostnames">Hostnames</h2><p>Make sure the hostnames and IP addresses of the servers are known to each other.
For this, check the content of <code>/etc/hosts</code></p><p><code>/etc/hosts</code></p><pre><code>37.153.173.244 server01-public
37.153.173.245 server01-public
10.3.0.44 server01-private
10.3.0.45 server02-private</code></pre>
<p>Note: these servers have two interfaces, Although this is not necessary, it is
strongly recommended to separate the traffic from the web and what you use for
the storage network. In our case, the web-facing IP addresses have not been
load-balanced yet. This is a topic for future articles.</p><h2 id="prepare-disks">Prepare disks</h2><p>Since Gluster relies on extended file attributes (xattr), we will need to increase
the inode size when formatting the disks.</p><p>Perform on the following on both the servers</p><pre><code>$ mkfs.xfs -i size=512 /dev/vdb</code></pre>
<pre><code>meta-data=/dev/vdb               isize=512    agcount=4, agsize=3276800 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=0
data     =                       bsize=4096   blocks=13107200, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=6400, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0</code></pre>
<p>Now we need to create a mountpoint for the filesystem. We will use
<code>/data/var-www/brick01</code> on <code>server01</code>:</p><pre><code>$ mkdir -p /data/var-www/brick01
$ echo &apos;/dev/vdb /data/var-www/brick01 xfs defaults 1 2&apos; &gt;&gt; /etc/fstab
$ mount -a </code></pre>
<p>and <code>/data/var-www/brick02</code> on <code>server02</code>:</p><pre><code>$ mkdir -p /data/var-www/brick02
$ echo &apos;/dev/vdb /data/var-www/brick02 xfs defaults 1 2&apos; &gt;&gt; /etc/fstab
$ mount -a </code></pre>
<h2 id="setup-gluster">Setup Gluster</h2><p>You will now create a cluster of Gluster servers, which means that we will create
a trust between the two nodes. But before we can do this, we need to make sure
the Gluster daemon is running on the nodes. Perform the following commands on
both of the nodes:</p><pre><code>$ systemctl enable glusterd
$ systemctl start glusterd
$ systemctl status glusterd</code></pre>
<p>Now we need to create the trusted connection. The following commands will only
need to be used on one of the nodes. In my case, this will be <code>server01</code>:</p><pre><code>$ gluster peer probe server02-private</code></pre>
<pre><code>peer probe: success.</code></pre>
<p>Note: the hostname here refers to the private IP address. This is not the same
range as the public network. For security purposes you will likely separate the
traffic.</p><p>You can verify is the trust exists by running:</p><pre><code>$ gluster peer status</code></pre>
<pre><code>Number of Peers: 1

Hostname: server02-private
Uuid: af523e9b-4257-485d-aa45-ebd24f115c42
State: Peer in Cluster (Connected)</code></pre>
<p>If you would run this command also on <code>server02</code>, you would get a similar result:</p><pre><code>Number of Peers: 1

Hostname: server01-private
Uuid: 74c77082-b62c-4cc4-b33f-02de36083990
State: Peer in Cluster (Connected)</code></pre>
<h2 id="create-gluster-volume">Create Gluster volume</h2><p>In case of a failure, we do not want our data to be unavailable. Therefore we
need to have two copies of our data, and we do this by creating a replicated
volume.</p><p>This command will only need to be run on one node, as Gluster will take care of
the related nodes.</p><pre><code>$ gluster volume create var-www replica 2 \
          server01-private:/data/var-www/brick01/volume \
          server02-private:/data/var-www/brick02/volume</code></pre>
<pre><code>volume create: var-www: success: please start the volume to access data</code></pre>
<pre><code>$ gluster volume start var-www</code></pre>
<pre><code>volume start: var-www: success</code></pre>
<pre><code>$ gluster volume info</code></pre>
<pre><code>Volume Name: var-www
Type: Replicate
Volume ID: e91014ca-f98c-42e5-8e75-de4d2e65f569
Status: Started
Number of Bricks: 1 x 2 = 2
Transport-type: tcp
Bricks:
Brick1: server01-private:/data/var-www/brick01/volume
Brick2: server02-private:/data/var-www/brick02/volume
Options Reconfigured:
transport.address-family: inet
performance.readdir-ahead: on
nfs.disable: on</code></pre>
<h2 id="mount-gluster-volume">Mount Gluster volume</h2><p>Before you can mount the volume on <code>/var/www</code> to share the webpages, we need to
move the original <code>/var/www</code> out of the way and create a new directory to mount.
Perform the following commands on both the servers:</p><pre><code>$ systemctl stop httpd
$ mv /var/www{,.orig}
$ mkdir /var/www</code></pre>
<p>Now that we have the mountpoint, we can add an entry to <code>fstab</code> to deal with
mounting of our volume. On <code>server01</code> you need to do the following:</p><pre><code>$ echo &apos;server01-private:/var-www /var/www glusterfs defaults,_netdev,fetch-attempts=3 0 0&apos; &gt;&gt; /etc/fstab
$ mount -a</code></pre>
<p>And on <code>server02</code>:</p><pre><code>$ echo &apos;server02-private:/var-www /var/www glusterfs defaults,_netdev,fetch-attempts=3 0 0&apos; &gt;&gt; /etc/fstab
$ mount -a</code></pre>
<p>Now the volume has been mounted and replication is available. We use <code>_netdev</code>
because network needs to be up before we can use this filesystem, and <code>fetch_attempts</code>
will deal with the volume information in case of a failure. Since we have multiple
IP address, this is a suggested setting.</p><h2 id="test-replication">Test replication</h2><p>On <code>server01</code> you can do the following:</p><pre><code>$ mkdir -p /var/www/html
$ echo &apos;Hello, World!&apos; &gt; /var/www/html/index.html
$ systemctl start httpd</code></pre>
<p>If you would now open the web facing IP address, you should see the message:
<code>Hello, World!</code>.</p><p>Note: if you have issues opening the page, or the default Fedora test page gets
returned, you might have SELinux enabled. In this case, you need to turn on the
following boolean:</p><pre><code>$ setsebool -P httpd_use_fusefs 1</code></pre>
<p>which will allow Apache to use the FUSE filesystem mount as used by GlusterFS.</p><p>Now, on <code>server02</code> you can check the content of the folder:</p><pre><code>$ ls /var/www/html</code></pre>
<p>and you would see an <code>index.html</code> file. Now start Apache and you will see that
the content is also served from this server.</p><pre><code>$ systemctl start httpd</code></pre>
<h2 id="conclusion">Conclusion</h2><p>Using GlusterFS it is easy to setup an environment that can handle issues with
storage availability. You now have a replicate volume that is available on two
servers. Actions we take on each of these servers, will be replicated to the
other server.</p><p>In this case we have setup the servers to handle both the storage and act as a
client to read these files. More advanced are available and are described in the
<a href="http://gluster.readthedocs.io/en/latest/" target="_blank">documentation</a>.</p><h2 id="next-step">Next step</h2><p>Now that we have implemented replicated storage for our webservers, we need to
provide a HA solution to deal with the traffic on the webfacing IP addresses.
In an OpenStack environment you could use Neutron to setup a loadbalancer and 
health monitor for the two servers. How to set this up in described in the
<a href="building-a-multi-tier-application-using-openstack-packstack.html">following article</a>.
However, you can also do so with HAProxy and a failover mechanism, which will be
the topic of a future article.</p><p>If you have questions please let me know on Twitter at <a href="http://twitter.com/gbraad" target="_blank">@gbraad</a> or by email.</p>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="0008-multitier-setup-openstack.html" class="navigation navigation-prev " aria-label="Previous page: Building a multi-tier application using OpenStack (PackStack)">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="0013-document-generation.html" class="navigation navigation-next " aria-label="Next page: Document generation using Markdown and Pandoc">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"Title":"Highly Available storage using GlusterFS","Date":"2016-9-12","Category":"High Availability","Tags":"gluster, high availability, web, storage","title":"Highly Available storage using GlusterFS","level":"3.7","depth":1,"next":{"title":"Document generation using Markdown and Pandoc","level":"3.8","depth":1,"path":"0013-document-generation.md","ref":"0013-document-generation.md","articles":[]},"previous":{"title":"Building a multi-tier application using OpenStack (PackStack)","level":"3.6","depth":1,"path":"0008-multitier-setup-openstack.md","ref":"0008-multitier-setup-openstack.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"0012-ha-storage-using-gluster.md","mtime":"2016-11-08T07:03:09.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2016-11-08T07:03:13.428Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

